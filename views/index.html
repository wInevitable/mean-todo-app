<!DOCTYPE html>
<html>
<head>
  <title>MEAN Todo App</title>
</head>
<body>
  <div>
    <h2>Todos</h2>
    <input type="text" id="text">
    <input type="button" id="add" value="+ Add new">

    <ul id="showAll"></ul>
  </div>

  <script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="DataManager.js"></script>

  <script>
    var options = {
      connection: 'http://localhost:2000',
      connectCallback: connectCallback,
      collections: [{
        'name': 'todos',
        'subscribers': {
          'allTodos': renderAllTodos
        },
      }]
    };

    var dataManager = new DataManager(options);

    function connectCallback() {
      console.log('connected');
    }

    function renderAllTodos(data) {
      console.log('datum', data);
      var html = '';
      if (!data) return;

      data.forEach(function(datum) {
        html += '<li>' + datum.name + ' [<a href="javascript:" data-name="' + datum.name + '" data-id="' + datum.id + '" class="edit-todo">Edit</a>] [<a href="javascript:" data-id="' + datum.id + '" class="remove-todo">Remove</a>]</li>';
      });

      $('#showAll').html(html);

      // bind event listeners
      $('.remove-todo').on('click', removeTodo);
      $('.edit-todo').on('click', editTodo);
    }

    $('#add').click(saveTodo);

    function saveTodo() {
      dataManager.pubData('todos', 'saveTodo', {
        id: Math.ceil(Math.random() * 1000),
        name: $('#text').val()
      }, function(savedToLocal) {
        console.log('savedToLocal : ', savedToLocal);
      });

      $('#text').val('');
    }

    function editTodo() {
      var name = $(this).data('name');
      var id = $(this).data('id');
      var updatedName = prompt('Update ' + name);

      if (updatedName && updatedName != name) {
        dataManager.pubData('todos', 'updateTodo', {
          id: id,
          name: updatedName
        }, function(savedToLocal) {
          console.log('savedToLocal : ', savedToLocal);
        });
      }
    }

    function removeTodo() {
      dataManager.pubData('todos', 'deleteTodo', {
        id: $(this).data('id')
      }, function(savedToLocal) {
        console.log('savedToLocal : ', savedToLocal);
      });
    }
  </script>
</body>
</html>
